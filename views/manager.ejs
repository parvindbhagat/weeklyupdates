<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Tasks</title>
  <link rel="stylesheet" href="https://use.typekit.net/oov2wcw.css" />
  <link
    href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css"
    rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="/stylesheets/style.css">
  <style>
    #topButton {
            position: fixed;
            bottom: 20px;
            right: 30px;
            display: none;
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
        }
  </style>
</head>
<body>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        window.activities = <%- JSON.stringify(tasks) %>;
        let tablediv = document.querySelector('.tablediv');
        console.log(activities.length);
        if (activities.length === 0) {
            tablediv.classList.add('hidden');
        } else {
            tablediv.classList.remove('hidden');
            // Populate the table with activities
        }
    });
</script>

<nav class="navbar">
  <a class="navbar-brand" href="/">
    <img src="/images/logo.png" alt="Chrysalis" >
  </a>
</nav>
<h1 style=" margin-right: 3rem; text-align: center;">Welcome, <%= user.name %> </h1>
<div class="d-flex flex-row-reverse gap-3">
  <form style="display: inline-block; margin-right: 3rem;" action="/logout" method="POST">
    <button type="submit" class="rounded">Logout</button>
  </form>
  <a class="me-3" href="/">Home</a> 
  <a class="me-3" href="/profile">My Tasks</a>
</div>

<% if (msg) { %>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
      <%= msg %>
      
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
          
  </div>  
<% } %>

<div class="tablediv mb-50 m-2 ">
  <!-- <div class="ms-3 my-3">
    <label for="resourceFilter">Filter by Resource Name:</label>
    <select id="resourceFilter" onchange="filterTable()">
      <option value="">All</option>
      <% 
        const uniqueResources = new Set();
        tasks.forEach(res => {
          uniqueResources.add(res.resourceName);
        });
        uniqueResources.forEach(manager => { 
      %>
        <option value="<%= manager %>"><%= manager %></option>
      <% }); %>
    </select>
  </div> -->
    <table class="table-striped full-width bg-white border border-gray-300" >
      <thead >
        <tr class="mx-2">
            <th  class="bg-warning mx-2">Project Name</th>
            <th  class="bg-warning mx-2">Task Name</th>
            <th  class="bg-warning mx-2">Scheduled Start</th>
            <th  class="bg-warning mx-2">Scheduled Finish</th>
            <th  class="bg-warning mx-2">Actual Start</th>
            <th  class="bg-warning mx-2">Actual Finish</th>            
            <th  class="bg-warning mx-2">Actual Work</th>
            <!-- <th  class="bg-warning mx-2">Submitted</th> -->
            <th  class="bg-warning mx-2">Complete</th>   
            <th  class="bg-warning mx-2">Comment</th>         
            <th  class="bg-warning mx-2">Status</th>
            <!-- <th  class="bg-warning">Action</th> -->
        </tr>
      </thead>
      <tbody>
        <% Object.keys(groupedMembers).forEach(resourceName => { %>
          <tr style="background-color: #e0e0e0 ; font-weight: bold; font-size: 1.5rem; position: sticky; top: 3rem;" class="resource-name-row">
            <td colspan="12"><%= resourceName %></td>
          </tr>
          <% let totalWork = 0; %>
          <% groupedMembers[resourceName].forEach(activity => { %>
          <tr class="tableData" id="row-<%= activity._id %>">
            <td class="border border-gray-300 px-1 py-1 "><%= activity.projectName %></td>
            <td class="border border-gray-300 px-1 py-1 "><%= activity.taskName %></td>
            <td class="border border-gray-300 px-1 py-1 "><%= new Date(activity.start).toLocaleDateString('en-in') %></td>
            <td class="border border-gray-300 px-1 py-1 "><%= new Date(activity.Finish).toLocaleDateString('en-in') %></td>
            <td class="border border-gray-300 px-1 py-1 "><%= activity.actualStart ? new Date(activity.actualStart).toLocaleDateString('en-in') : " " %></td>
            <td class="border border-gray-300 px-1 py-1 "><%= activity.actualFinish ? new Date(activity.actualFinish).toLocaleDateString('en-in') : " " %></td>
            <td class="border border-gray-300 px-1 py-1 "><%= activity.actualWork %></td>
            <!-- <td class="border border-gray-300 px-1 py-1 "><%= activity.submitted %></td> -->
            <td class="border border-gray-300 px-1 py-1 "><%= (activity.taskCompletePercent < 100) ? "No" : "Yes" %></td>
            <td class="border border-gray-300 px-1 py-1 "><%= activity.userComment %></td>
            <td class="border border-gray-300 px-1 py-1 "><%= activity.approvalStatus %></td>
            <!-- <td class="text-center px-2"><button class="btn btn-primary update-btn border border-gray-300" data-id="<%= activity._id %>">Update</button></td> -->
            <% totalWork += parseFloat(activity.actualWork) || 0; %>
          </tr>          
        <% }); %>
        <tr style="background-color: #0dbeb0 ; font-weight: bold; color: white;" class="resource-name-row">
          <td colspan="8"> Total work by <%= resourceName %>: <%= totalWork %> Hrs.          </td>
          <td colspan="1"><button class="btn btn-primary approve-btn border border-gray-300" data-id="<%= resourceName %>" data-bs-toggle="tooltip" data-bs-placement="top" title="Approve all task entries and work done and Reassign Incomplete tasks.">Approve All</button></td>
          <td colspan="1"><button class="btn btn-primary reassign-btn border border-gray-300" data-id="<%= resourceName %>" data-bs-toggle="tooltip" data-bs-placement="top" title="Reassign all tasks to the member to make changes as per your Comment.">Reassign</button></td>
          
        </tr>
        <tr>
          <td colspan="10" style="color: white;">.  </td>
          
        </tr>
        <% }); %>
      </tbody>
    </table>
</div>

<!-- Update task modal form -->
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="updateModalLabel">Fill TimeSheet for Task</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <form id="updateForm" action="/updatetask" method="post">
                <div class="mb-3">
                  <label for="resourceName" class="form-label">Resource Name</label>
                  <input type="text" class="form-control" id="resourceName" name="resourceName" readonly>
                </div>
                  <div class="mb-3">
                      <label for="projectName" class="form-label">Project Name</label>
                      <input type="text" class="form-control" id="projectName" name="projectName" readonly>
                  </div>
                  <div class="mb-3">
                      <label for="taskName" class="form-label">Task Name</label>
                      <input type="text" class="form-control" id="taskName" name="taskName" readonly>
                  </div>
                  <div class="mb-3">
                      <label for="scheduledStart" class="form-label">Scheduled Start</label>
                      <input type="text" class="form-control" id="scheduledStart" name="scheduledStart" readonly>
                  </div>
                  <div class="mb-3">
                      <label for="scheduledFinish" class="form-label">Scheduled Finish</label>
                      <input type="text" class="form-control" id="scheduledFinish" name="scheduledFinish" readonly>
                  </div>
                  <div class="mb-3">
                      <label for="actualStart" class="form-label">Actual Start</label>
                      <input type="text" class="form-control" id="actualStart" name="actualStart">
                  </div>
                  <div class="mb-3">
                      <label for="actualFinish" class="form-label">Actual Finish</label>
                      <input type="text" class="form-control" id="actualFinish" name="actualFinish">
                  </div>
                  <div class="mb-3">
                      <label for="actualWork" class="form-label">Actual Work</label>
                      <input type="text" class="form-control" id="actualWork" name="actualWork">
                  </div>
                  <div class="mb-3">
                      <label for="comment" class="form-label">Comment</label>
                      <input type="text" class="form-control" id="comment" name="comment">
                  </div>
                  <div class="mb-3">
                    <label for="status" class="form-label">Status update</label>                    
                    <select id="status" name="status" class="form-select form-control my-2" aria-label="Default select " required>
                      <option selected>Awaiting Approval</option>
                      <option value="Approved">Approve</option>
                      <option value="Reassign">Reassign</option>                      
                    </select>
                </div>
                  <input type="hidden" id="activityId" name="activityId">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="submit" class="btn btn-primary" id="submitUpdate">Submit Task Completion</button>
              </form>
          </div>
          <div class="modal-footer">
              <p> Caution! Once submitted, you cannot make any changes to this Task.</p>
          </div>
      </div>
  </div>
</div>

<div class="footer" >
  <h4 class="footext">That was all!  </h4>
  <!-- <p style=" text-align: center; position: relative; bottom: 1px;">Copyright © 2024  <a href="https://chrysalis.in" style="text-decoration: none;">Chrysalis HRD</a></p> -->
</div>

<button id="topButton" onclick="scrollToTop()">TOP</button>
    <script>
        // Show the button when the user scrolls down 20px from the top of the document
        window.onscroll = function() {scrollFunction()};

        function scrollFunction() {
            if (document.body.scrollTop > 50 || document.documentElement.scrollTop > 50) {
                document.getElementById("topButton").style.display = "block";
            } else {
                document.getElementById("topButton").style.display = "none";
            }
        }

        // Scroll to the top of the document
        function scrollToTop() {
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;
        }
    </script>
  <!-- <pre><%= JSON.stringify(tasks, null, 2) %></pre> -->   

   <script src="/javascripts/bootstrap.bundle.min.js"></script>
</body>